<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Подання заявки</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%); min-height: 100vh; font-family: 'Inter', sans-serif; color: white; padding: 12px; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 1.5rem; }
        .label-style { font-size: 9px; text-transform: uppercase; font-weight: 800; color: #94a3b8; margin-bottom: 0.2rem; display: block; }
        input, select { background: #0f172a !important; color: white !important; border: 1px solid #334155 !important; border-radius: 0.75rem !important; padding: 0.75rem !important; width: 100%; outline: none; font-size: 14px; }
        input:focus { border-color: #a855f7 !important; box-shadow: 0 0 0 2px rgba(168, 85, 247, 0.2); }
        .drone-item { background: rgba(15, 23, 42, 0.6); border: 1px solid #334155; border-radius: 0.75rem; padding: 0.5rem 0.75rem; display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .drone-item input:checked + span { color: #a855f7; font-weight: bold; }
    </style>
</head>
<body class="max-w-lg mx-auto">
    <div class="flex justify-between items-center mb-6">
        <button onclick="window.location.href='/'" class="glass p-3 rounded-xl hover:bg-slate-800"><i class="fa-solid fa-chevron-left text-slate-400"></i></button>
        <div class="text-center">
            <h1 class="text-xl font-black uppercase italic tracking-wider text-purple-400">Створення заявки</h1>
            <div class="text-[8px] uppercase font-bold text-slate-500 tracking-widest">Flight Permission System</div>
        </div>
        <div class="w-10"></div>
    </div>

    <div class="glass p-5 mb-4 border-purple-500/20">
        <label class="label-style text-purple-400">Отримувач (ЦУС)</label>
        <div class="grid grid-cols-3 gap-2">
            <select id="cusMessenger" class="col-span-1">
                <option value="whatsapp">WhatsApp</option>
                <option value="signal">Signal</option>
            </select>
            <input type="tel" id="cusPhone" placeholder="380..." class="col-span-2">
        </div>
    </div>

    <div class="glass p-6 space-y-5 shadow-2xl">
        <div>
            <label class="label-style">1. Заявник</label>
            <select id="reqUnit"></select>
        </div>

        <div>
            <label class="label-style">2. Тип БпЛА (Оберіть один або декілька)</label>
            <div id="droneList" class="grid grid-cols-1 gap-2 max-h-40 overflow-y-auto pr-2">
                </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
            <div><label class="label-style">3. Дата (З)</label><input type="date" id="dateStart"></div>
            <div><label class="label-style">Дата (ПО)</label><input type="date" id="dateEnd"></div>
        </div>

        <div class="grid grid-cols-2 gap-3">
            <div><label class="label-style">4. Час (З)</label><input type="time" id="timeStart" value="08:00"></div>
            <div><label class="label-style">Час (ПО)</label><input type="time" id="timeEnd" value="20:00"></div>
        </div>

        <div>
            <label class="label-style">5. Маршрут (н.п. / Район)</label>
            <input type="text" id="reqRoute" list="routeHistory" placeholder="наприклад: Круті - Плоть">
            <datalist id="routeHistory"></datalist>
        </div>

        <div class="grid grid-cols-2 gap-3">
            <div><label class="label-style">6. Висота (м)</label><input type="number" id="height" value="300"></div>
            <div><label class="label-style">7. Радіус (км)</label><input type="number" id="radius" value="3"></div>
        </div>

        <div>
            <label class="label-style">8. Мета польоту</label>
            <select id="reqTarget">
                <option>патрулювання ділянки відповідальності</option>
                <option>за оперативною необхідністю</option>
                <option>навчально-тренувальні польоти</option>
            </select>
        </div>

        <div class="pt-2 border-t border-slate-700/50">
            <label class="label-style">9. Контактна особа</label>
            <div class="grid grid-cols-2 gap-3">
                <input type="text" id="reqContact" placeholder="Звання Прізвище">
                <input type="tel" id="reqMyPhone" placeholder="Тел: 050...">
            </div>
        </div>

        <button onclick="sendApplication()" class="w-full bg-purple-600 hover:bg-purple-500 py-4 rounded-2xl font-black uppercase text-sm tracking-widest shadow-lg shadow-purple-500/20 active:scale-95 transition-all">
            Відправити заявку <i class="fa-solid fa-paper-plane ml-2"></i>
        </button>
    </div>

    <script>
        const API = window.location.origin + "/api";

        window.onload = async function() {
            const unit = localStorage.getItem('uav_unit');
            const op = localStorage.getItem('uav_op');
            
            // Відновлення даних
            document.getElementById('cusPhone').value = localStorage.getItem('cus_phone') || "";
            document.getElementById('cusMessenger').value = localStorage.getItem('cus_mess') || "whatsapp";
            document.getElementById('reqMyPhone').value = localStorage.getItem('my_phone') || "";
            document.getElementById('reqContact').value = op || "";

            const res = await fetch(API + "/get_options");
            const opt = await res.json();
            document.getElementById('reqUnit').innerHTML = opt.units.map(u => `<option ${u === unit ? 'selected' : ''}>${u}</option>`).join('');

            loadDrones(unit);
            
            // Історія маршрутів
            const hist = JSON.parse(localStorage.getItem('req_route_hist') || "[]");
            document.getElementById('routeHistory').innerHTML = hist.map(r => `<option value="${r}">`).join('');

            document.getElementById('dateStart').valueAsDate = new Date();
            document.getElementById('dateEnd').valueAsDate = new Date();
        };

        async function loadDrones(unit) {
            const res = await fetch(API + "/get_unit_drones?unit=" + encodeURIComponent(unit));
            const drones = await res.json();
            document.getElementById('droneList').innerHTML = drones.map(d => `
                <label class="drone-item">
                    <input type="checkbox" name="drones" value="${d.model} (S/N: ${d.serial_number})" class="w-4 h-4 accent-purple-500">
                    <span class="text-[11px] text-slate-300">${d.model} <span class="text-slate-500 font-mono">[${d.serial_number}]</span></span>
                </label>
            `).join('');
        }

        function sendApplication() {
            const phone = document.getElementById('cusPhone').value.replace(/\+/g, '');
            const messenger = document.getElementById('cusMessenger').value;
            
            // Зберігаємо для наступного разу
            localStorage.setItem('cus_phone', phone);
            localStorage.setItem('cus_mess', messenger);
            localStorage.setItem('my_phone', document.getElementById('reqMyPhone').value);

            // Отримуємо список дронів
            const selectedDrones = Array.from(document.querySelectorAll('input[name="drones"]:checked')).map(cb => cb.value);
            if(selectedDrones.length === 0) return alert("Оберіть хоча б один БпЛА!");

            // Формуємо текст за вашим шаблоном
            const formatDate = (dateStr) => dateStr.split('-').reverse().join('.');

const msg = `
1. Заявник: в/ч 2196 2 ПРИКЗ (ДПСУ) ${document.getElementById('reqUnit').value}
2. Тип БпЛА: ${selectedDrones.join(', ')}
3. Дата здійснення польоту: ${formatDate(document.getElementById('dateStart').value)} - ${formatDate(document.getElementById('dateEnd').value)}
4. Час роботи: з ${document.getElementById('timeStart').value} по ${document.getElementById('timeEnd').value}
5. Населений пункт (маршрут): ${document.getElementById('reqRoute').value}
6. Висота роботи (м): до ${document.getElementById('height').value} м
7. Радіус роботи (км): до ${document.getElementById('radius').value} км
8. Мета польоту: ${document.getElementById('reqTarget').value}
9. Контактна особа: ${document.getElementById('reqContact').value}, тел: ${document.getElementById('reqMyPhone').value}`;

            // Відправка
            const encoded = encodeURIComponent(msg);
            if(messenger === 'whatsapp') {
                window.location.href = `https://wa.me/${phone}?text=${encoded}`;
            } else {
                // Пряме посилання для Signal
                window.location.href = `sgnl://send?text=${encoded}${phone ? '&number=' + phone : ''}`;
                // Fallback через 1 сек якщо додаток не відкрився
                setTimeout(() => { if(!document.hidden) window.location.href = `https://signal.me/#p/${phone}`; }, 1000);
            }
        }
    </script>
</body>
</html>
