<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel | UAV Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { background: #0f172a; color: white; font-family: 'Inter', sans-serif; padding: 20px; }
        .card { background: rgba(30, 41, 59, 0.5); border: 1px solid rgba(255,255,255,0.1); border-radius: 1rem; }
        .input-dark { background: #1e293b; border: 1px solid #334155; color: white; border-radius: 0.5rem; padding: 0.5rem; width: 100%; outline: none; transition: all 0.2s; font-size: 13px; }
        .input-dark:focus { border-color: #22c55e; box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2); }
        .label-mini { font-size: 10px; text-transform: uppercase; font-weight: 700; color: #94a3b8; margin-bottom: 4px; display: block; }
        .tech-table { width: 100%; border-collapse: separate; border-spacing: 0; }
        .tech-table th { background: #1e293b; color: #94a3b8; font-size: 10px; text-transform: uppercase; font-weight: 800; padding: 1rem; text-align: left; border-bottom: 1px solid #334155; }
        .tech-table td { padding: 1rem; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 13px; }
        .tech-tag { font-size: 10px; font-weight: 900; text-transform: uppercase; padding: 0.25rem 0.5rem; border-radius: 0.375rem; background: rgba(255,255,255,0.05); }
    </style>
</head>
<body class="max-w-7xl mx-auto">

    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-3xl font-black italic text-green-500 uppercase tracking-tighter">Admin Panel</h1>
            <p class="text-slate-500 text-xs font-bold uppercase tracking-widest mt-1">UAV Command System Center</p>
        </div>
        <div class="flex gap-3">
            <button onclick="nav('/')" class="bg-slate-800 p-3 rounded-xl text-slate-400 hover:text-white transition-all">
                <i class="fa-solid fa-house"></i>
            </button>
            <button onclick="exportAllToExcel()" class="bg-green-600 hover:bg-green-500 px-6 py-3 rounded-xl text-slate-900 font-black uppercase text-xs shadow-lg shadow-green-500/20 transition-all">
                <i class="fa-solid fa-file-excel mr-2"></i> Експорт Журналу
            </button>
            <button onclick="nav('/admin_analytics')" class="bg-orange-600 hover:bg-orange-500 px-6 py-3 rounded-xl text-white font-black uppercase text-xs shadow-lg shadow-orange-500/20 transition-all">
                <i class="fa-solid fa-chart-pie mr-2"></i> Аналітика
            </button>
        </div>
    </div>

    <div class="card p-6 mb-6 border-l-4 border-purple-500 bg-slate-800/50">
        <h3 class="text-sm font-black uppercase text-purple-400 mb-4 flex items-center">
            <i class="fa-solid fa-bullhorn mr-2"></i>Налаштування оголошення
        </h3>
        <div class="flex flex-col gap-4">
            <textarea id="adminMsgText" class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-sm text-white h-20 focus:border-purple-500 outline-none transition-colors font-mono" placeholder="Введіть текст оголошення для пілотів..."></textarea>
            <div class="flex items-center justify-between">
                <label class="flex items-center gap-3 cursor-pointer select-none group">
                    <div class="relative">
                        <input type="checkbox" id="adminMsgActive" class="sr-only peer">
                        <div class="w-11 h-6 bg-slate-700 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600 group-hover:bg-slate-600"></div>
                    </div>
                    <span class="text-xs font-bold uppercase text-slate-300 group-hover:text-white transition-colors">Активувати показ на головній</span>
                </label>
                <button onclick="saveAnnouncement()" class="bg-purple-600 hover:bg-purple-500 px-6 py-2 rounded-xl text-white font-black uppercase text-xs shadow-lg shadow-purple-500/20 transition-all active:scale-95">
                    <i class="fa-solid fa-floppy-disk mr-2"></i> Зберегти
                </button>
            </div>
        </div>
    </div>

    <div class="card p-5 mb-6">
        <div class="flex justify-between items-center mb-3">
            <h3 class="text-xs font-black uppercase text-slate-400 flex items-center gap-2">
                <i class="fa-solid fa-filter text-green-500"></i> Фільтрація даних
            </h3>
            <button onclick="resetFilters()" class="text-[10px] text-slate-500 hover:text-white uppercase font-bold transition-colors">
                <i class="fa-solid fa-rotate-left mr-1"></i> Скинути
            </button>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-3">
            <div>
                <label class="label-mini">Дата з</label>
                <input type="date" id="filterDateFrom" oninput="filterData()" class="input-dark">
            </div>
            <div>
                <label class="label-mini">Дата по</label>
                <input type="date" id="filterDateTo" oninput="filterData()" class="input-dark">
            </div>
            
            <div>
                <label class="label-mini">Час зльоту з</label>
                <input type="time" id="filterTimeFrom" oninput="filterData()" class="input-dark">
            </div>
            <div>
                <label class="label-mini">Час зльоту по</label>
                <input type="time" id="filterTimeTo" oninput="filterData()" class="input-dark">
            </div>

            <div>
                <label class="label-mini">Підрозділ</label>
                <input type="text" id="filterUnit" oninput="filterData()" placeholder="Введіть назву..." class="input-dark">
            </div>
            <div>
                <label class="label-mini">Пілот (Прізвище)</label>
                <input type="text" id="filterOp" oninput="filterData()" placeholder="Введіть прізвище..." class="input-dark">
            </div>
        </div>
    </div>

    <div class="card overflow-hidden">
        <div class="overflow-x-auto">
            <table class="tech-table">
                <thead>
                    <tr>
                        <th>Дата</th>
                        <th>Підрозділ</th>
                        <th>Оператор</th>
                        <th>Тип БпЛА</th>
                        <th>Час (Зліт-Пос)</th>
                        <th>Наліт</th>
                        <th>Результат</th>
                        <th class="text-right">Дії</th> 
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
        <div id="noDataMessage" class="hidden text-center py-10 text-slate-500 text-xs uppercase font-bold">
            Записів не знайдено
        </div>
    </div>

    <script>
        let allFlights = [];

        function nav(path) {
            const token = new URLSearchParams(window.location.search).get('token');
            window.location.href = token ? `${path}?token=${token}` : path;
        }

        async function loadAllFlights() {
            try {
                const res = await fetch("/api/get_all_flights");
                allFlights = await res.json();
                renderTable(allFlights);
            } catch (e) {
                console.error("Error loading flights:", e);
            }
        }

        // --- ЛОГІКА ОГОЛОШЕННЯ ---
        async function loadAdminAnnouncement() {
            try {
                const res = await fetch('/api/get_announcement');
                const data = await res.json();
                document.getElementById('adminMsgText').value = data.announcement_text || "";
                document.getElementById('adminMsgActive').checked = data.is_announcement_active;
            } catch (e) { console.error(e); }
        }

        async function saveAnnouncement() {
            const text = document.getElementById('adminMsgText').value;
            const isActive = document.getElementById('adminMsgActive').checked;
            if(!text && isActive) return alert("Введіть текст оголошення!");

            try {
                const res = await fetch('/api/update_announcement', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ text: text, is_active: isActive })
                });
                if(res.ok) alert("Налаштування оголошення оновлено!");
            } catch (e) { alert("Помилка з'єднання!"); }
        }

        // --- ЛОГІКА ВИДАЛЕННЯ ---
        async function deleteFlight(id) {
            if(!confirm("Ви впевнені, що хочете видалити цей запис?")) return;
            try {
                const res = await fetch(`/api/delete_flight/${id}`, { method: 'DELETE' });
                if(res.ok) {
                    allFlights = allFlights.filter(f => f.id !== id);
                    filterData(); // Оновлюємо таблицю з урахуванням поточних фільтрів
                } else { alert("Помилка при видаленні."); }
            } catch (e) { alert("Помилка з'єднання."); }
        }

        // --- ЛОГІКА ФІЛЬТРАЦІЇ (НОВЕ) ---
        function filterData() {
            // Отримуємо значення фільтрів
            const dFrom = document.getElementById('filterDateFrom').value;
            const dTo = document.getElementById('filterDateTo').value;
            const tFrom = document.getElementById('filterTimeFrom').value;
            const tTo = document.getElementById('filterTimeTo').value;
            const sUnit = document.getElementById('filterUnit').value.toLowerCase();
            const sOp = document.getElementById('filterOp').value.toLowerCase();

            const filtered = allFlights.filter(f => {
                // 1. Перевірка Дати
                if (dFrom && f.date < dFrom) return false;
                if (dTo && f.date > dTo) return false;

                // 2. Перевірка Часу (по часу зльоту)
                if (tFrom && f.takeoff < tFrom) return false;
                if (tTo && f.takeoff > tTo) return false;

                // 3. Перевірка Тексту (Підрозділ)
                if (sUnit && !f.unit.toLowerCase().includes(sUnit)) return false;

                // 4. Перевірка Тексту (Оператор)
                if (sOp && !f.operator.toLowerCase().includes(sOp)) return false;

                return true;
            });

            renderTable(filtered);
        }

        function resetFilters() {
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            document.getElementById('filterTimeFrom').value = '';
            document.getElementById('filterTimeTo').value = '';
            document.getElementById('filterUnit').value = '';
            document.getElementById('filterOp').value = '';
            renderTable(allFlights);
        }
        // -------------------------

        function renderTable(flights) {
            const tbody = document.getElementById('tableBody');
            const noData = document.getElementById('noDataMessage');

            if (flights.length === 0) {
                tbody.innerHTML = '';
                noData.classList.remove('hidden');
                return;
            }
            noData.classList.add('hidden');

            tbody.innerHTML = flights.map(f => {
                const dateF = f.date && f.date.includes('-') ? f.date.split('-').reverse().join('.') : f.date;
                return `
                <tr class="hover:bg-white/5 transition-colors group">
                    <td class="font-mono text-slate-400 text-xs">${dateF}</td>
                    <td class="font-bold text-green-500">${f.unit}</td>
                    <td class="font-medium">${f.operator}</td>
                    <td class="text-slate-300 text-xs uppercase">${f.drone}</td>
                    <td class="font-mono text-slate-400">${f.takeoff} - ${f.landing}</td>
                    <td class="font-black">${f.duration} <span class="text-[10px] text-slate-500">хв</span></td>
                    <td>
                        <span class="tech-tag ${f.result === 'Затримання' ? 'text-red-400' : 'text-slate-400'}">
                            ${f.result || '---'}
                        </span>
                    </td>
                    <td class="text-right">
                        <button onclick="deleteFlight(${f.id})" class="text-slate-600 hover:text-red-500 transition-colors p-2" title="Видалити запис">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </td>
                </tr>
                `;
            }).join('');
        }

        function exportAllToExcel() {
            // Експортуємо ТІЛЬКИ відфільтровані дані, якщо користувач щось шукав? 
            // Або всі? Логічніше експортувати всі, або додати опцію.
            // В даному випадку залишаємо експорт ВСІХ записів, як і було.
            if (allFlights.length === 0) return alert("Немає даних для експорту");

            const sheetData = [
                ["ЖУРНАЛ обліку польотів (ЗАГАЛЬНИЙ)"],
                [],
                ["№", "Дата", "Вид БпЛА", "Ділянка", "Час", "", "Трив.", "Підрозділ", "ПІБ", "АКБ", "Цикли"],
                ["", "", "", "", "Зліт", "Пос.", "хв.", "", "", "", ""]
            ];

            allFlights.forEach((f, i) => {
                const dateFormatted = f.date && f.date.includes('-') ? f.date.split('-').reverse().join('.') : f.date;
                sheetData.push([
                    i + 1, dateFormatted, f.drone, f.route || "---", f.takeoff, f.landing,
                    f.duration, f.unit, f.operator, f.battery_id || "", f.battery_cycles || ""
                ]);
            });

            const ws = XLSX.utils.aoa_to_sheet(sheetData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Log");
            XLSX.writeFile(wb, `Admin_Journal_${new Date().toLocaleDateString()}.xlsx`);
        }

        window.onload = async () => {
            await loadAllFlights();
            await loadAdminAnnouncement();
        };
    </script>
</body>
</html>
