<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UAV Global Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background: #020617; color: #f1f5f9; font-family: sans-serif; }
        th { background: #1e293b; color: #94a3b8; font-size: 10px; text-transform: uppercase; padding: 12px; }
        td { border-bottom: 1px solid #1e293b; padding: 10px; font-size: 12px; }
        tr:hover { background: rgba(34, 197, 94, 0.05); }
    </style>
</head>
<body class="p-4">
    <div class="max-w-7xl mx-auto">
        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <h1 class="text-xl font-black uppercase text-green-500 italic tracking-tighter">Загальний моніторинг польотів</h1>
            <button onclick="exportAll()" class="bg-green-600 px-6 py-2 rounded-xl text-xs font-black uppercase">Експорт ВСІЄЇ БАЗИ</button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-6 bg-slate-900/50 p-4 rounded-2xl border border-slate-800">
            <input type="text" id="fUnit" onkeyup="globalFilter()" placeholder="Фільтр підрозділу" class="bg-slate-950 p-2 rounded-lg text-xs border border-slate-700">
            <input type="text" id="fOp" onkeyup="globalFilter()" placeholder="Фільтр оператора" class="bg-slate-950 p-2 rounded-lg text-xs border border-slate-700">
            <input type="date" id="fDate" onchange="globalFilter()" class="bg-slate-950 p-2 rounded-lg text-xs border border-slate-700">
            <div class="text-[10px] text-slate-500 flex items-center justify-end">Усього польотів: <span id="totalCount" class="text-white ml-2 font-bold">0</span></div>
        </div>

        <div class="overflow-x-auto bg-slate-900/30 rounded-2xl border border-slate-800">
            <table class="w-full text-left border-collapse" id="adminTable">
                <thead>
                    <tr>
                        <th>Дата</th><th>Підрозділ</th><th>Оператор</th><th>БпЛА</th><th>Зліт-Посадка</th><th>Наліт</th><th>Дистанція</th><th>АКБ</th><th>Результат</th>
                    </tr>
                </thead>
                <tbody id="adminBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        const API = window.location.origin + "/api";
        let allData = [];

        async function loadAll() {
            // Для адміна ми зробимо окремий маршрут або використаємо існуючий
            // Але оскільки нам треба ВСІ дані, додамо в main.py новий ендпоінт
            const res = await fetch(`${API}/get_all_flights`);
            allData = await res.json();
            renderTable(allData);
        }

        function renderTable(data) {
            const body = document.getElementById('adminBody');
            document.getElementById('totalCount').innerText = data.length;
            body.innerHTML = data.map(f => `
                <tr>
                    <td class="font-mono text-green-500">${f.date}</td>
                    <td class="font-bold">${f.unit}</td>
                    <td>${f.operator}</td>
                    <td class="text-blue-400">${f.drone.split(' (')[0]}</td>
                    <td class="font-mono">${f.takeoff}-${f.landing}</td>
                    <td>${f.duration} хв</td>
                    <td>${f.distance} м</td>
                    <td class="text-slate-500">${f.battery_id}</td>
                    <td class="${f.result === 'Затримання' ? 'text-red-500 font-bold' : ''}">${f.result}</td>
                </tr>
            `).join('');
        }

        function globalFilter() {
            const u = document.getElementById('fUnit').value.toLowerCase();
            const o = document.getElementById('fOp').value.toLowerCase();
            const d = document.getElementById('fDate').value;

            const filtered = allData.filter(f => {
                return (f.unit.toLowerCase().includes(u)) && 
                       (f.operator.toLowerCase().includes(o)) && 
                       (d === "" || f.date === d);
            });
            renderTable(filtered);
        }

        function exportAll() {
            const ws = XLSX.utils.json_to_sheet(allData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Global_Log");
            XLSX.writeFile(wb, "Global_UAV_Report.xlsx");
        }
        loadAll();
    </script>
</body>
</html>
