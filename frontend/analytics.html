<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Моя Аналітика | UAV Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { background: #0f172a; font-family: 'Inter', sans-serif; color: white; padding: 12px; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 1.5rem; }
        .stat-card { background: rgba(15, 23, 42, 0.6); padding: 15px; border-radius: 1rem; border: 1px solid rgba(255,255,255,0.05); transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-2px); border-color: rgba(255,255,255,0.1); }
        
        /* Стилі для інпутів */
        select, input { background: #1e293b !important; color: white !important; border: 1px solid #334155 !important; border-radius: 0.5rem; padding: 4px 8px; font-size: 11px; outline: none; width: 100%; }
        select:focus, input:focus { border-color: #f97316 !important; }
        
        .user-highlight { color: #22c55e; font-weight: 900; text-transform: uppercase; letter-spacing: 0.05em; }
        .label-mini { font-size: 9px; text-transform: uppercase; font-weight: 700; color: #94a3b8; margin-bottom: 2px; display: block; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
    </style>
</head>
<body class="max-w-6xl mx-auto pb-10">
    
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4 pt-4 px-2">
        <div class="flex items-center gap-4">
            <button onclick="window.location.href='/'" class="p-2 bg-slate-800 rounded-xl text-slate-400 hover:text-white transition-all border border-slate-700">
                <i class="fa-solid fa-arrow-left"></i>
            </button>
            <div>
                <h1 class="text-xl font-black uppercase italic text-orange-500 tracking-tighter leading-none">Особиста Аналітика</h1>
                <p id="userDisplay" class="text-[10px] user-highlight mt-1">Завантаження...</p>
            </div>
        </div>

        <div class="flex items-center gap-2 glass px-3 py-2">
            <select id="monthSelect" onchange="updateAnalytics()" class="w-auto">
                <option value="01">Січень</option><option value="02">Лютий</option>
                <option value="03">Березень</option><option value="04">Квітень</option>
                <option value="05">Травень</option><option value="06">Червень</option>
                <option value="07">Липень</option><option value="08">Серпень</option>
                <option value="09">Вересень</option><option value="10">Жовтень</option>
                <option value="11">Листопад</option><option value="12">Грудень</option>
            </select>
            <select id="yearSelect" onchange="updateAnalytics()" class="w-auto">
                <option value="2025">2025</option><option value="2026" selected>2026</option>
            </select>
        </div>
    </div>

    <div class="glass p-4 mb-6 mx-2 border-l-4 border-orange-500">
        <div class="flex flex-col md:flex-row items-end gap-3">
            <div class="w-full md:w-auto">
                <label class="label-mini">Конкретна дата</label>
                <input type="date" id="filterDate" onchange="updateAnalytics()">
            </div>
            
            <div class="w-full md:w-auto flex gap-2">
                <div class="w-1/2 md:w-auto">
                    <label class="label-mini">Час з</label>
                    <input type="time" id="filterTimeStart" onchange="updateAnalytics()">
                </div>
                <div class="w-1/2 md:w-auto">
                    <label class="label-mini">Час по</label>
                    <input type="time" id="filterTimeEnd" onchange="updateAnalytics()">
                </div>
            </div>

            <div class="w-full md:w-auto">
                <label class="label-mini">Модель БпЛА</label>
                <select id="filterDrone" onchange="updateAnalytics()">
                    <option value="">Всі борти</option>
                </select>
            </div>

            <div class="w-full md:w-auto">
                <label class="label-mini">Результат</label>
                <select id="filterResult" onchange="updateAnalytics()">
                    <option value="">Всі результати</option>
                </select>
            </div>

            <button onclick="resetFilters()" class="w-full md:w-auto bg-slate-700 hover:bg-slate-600 text-white text-[10px] font-bold uppercase py-1.5 px-4 rounded-lg transition-colors h-[26px]">
                <i class="fa-solid fa-rotate-left mr-1"></i> Скинути
            </button>
        </div>
    </div>

    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 px-2">
        <div class="stat-card border-l-4 border-green-500">
            <div class="text-[10px] text-slate-500 font-black uppercase italic">Вильоти</div>
            <div id="totalFlights" class="text-2xl font-black text-white mt-1">0</div>
        </div>
        <div class="stat-card border-l-4 border-blue-500">
            <div class="text-[10px] text-slate-500 font-black uppercase italic">Наліт</div>
            <div id="totalDuration" class="text-2xl font-black text-blue-400 mt-1">0г 0хв</div>
        </div>
        <div class="stat-card border-l-4 border-red-500">
            <div class="text-[10px] text-slate-500 font-black uppercase italic">Затримання</div>
            <div id="totalResults" class="text-2xl font-black text-red-500 mt-1">0</div>
        </div>
        <div class="stat-card border-l-4 border-purple-500">
            <div class="text-[10px] text-slate-500 font-black uppercase italic">Ефективність</div>
            <div id="efficiencyRate" class="text-2xl font-black text-purple-400 mt-1">0%</div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6 px-2">
        
        <div class="lg:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div class="glass p-5">
                <h2 class="text-xs font-black uppercase mb-4 text-slate-400 italic flex items-center gap-2">
                    <i class="fa-solid fa-plane-up text-orange-500"></i> Улюблений борт
                </h2>
                <div class="space-y-4" id="droneRating"></div>
            </div>

            <div class="glass p-5">
                <h2 class="text-xs font-black uppercase mb-4 text-slate-400 italic flex items-center gap-2">
                    <i class="fa-solid fa-battery-full text-teal-500"></i> Ресурс моїх АКБ
                </h2>
                <div class="space-y-2 overflow-y-auto max-h-[150px] pr-2" id="batteryResource"></div>
            </div>
        </div>

        <div class="glass p-5 bg-gradient-to-b from-slate-800/50 to-slate-900/50">
            <h2 class="text-xs font-black uppercase mb-4 text-yellow-500 italic flex items-center gap-2">
                <i class="fa-solid fa-trophy"></i> Особисті Рекорди
            </h2>
            <div class="space-y-4">
                <div class="border-b border-white/5 pb-3">
                    <div class="text-[10px] text-slate-500 uppercase">Найдовший політ</div>
                    <div id="maxTime" class="text-xl font-black text-white">---</div>
                    <div id="maxTimeDate" class="text-[9px] text-slate-600 font-mono">---</div>
                </div>
                <div class="border-b border-white/5 pb-3">
                    <div class="text-[10px] text-slate-500 uppercase">Макс. дистанція</div>
                    <div id="maxDist" class="text-xl font-black text-white">---</div>
                    <div id="maxDistDate" class="text-[9px] text-slate-600 font-mono">---</div>
                </div>
                <div>
                    <div class="text-[10px] text-slate-500 uppercase">Найкращий день</div>
                    <div id="bestDay" class="text-xl font-black text-white">---</div>
                    <div id="bestDayCount" class="text-[9px] text-green-500 font-bold uppercase">0 вильотів</div>
                </div>
            </div>
        </div>
    </div>

    <div class="glass p-6 mx-2">
        <h2 class="text-xs font-black uppercase mb-4 text-slate-400 italic flex items-center gap-2">
            <i class="fa-solid fa-list-check text-blue-500"></i> Детальний Журнал вильотів
        </h2>
        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse min-w-[600px]">
                <thead>
                    <tr class="text-[9px] text-slate-500 uppercase border-b border-slate-700 tracking-wider">
                        <th class="py-3 pl-2">Дата / Час</th>
                        <th class="py-3">Борт / №</th>
                        <th class="py-3">Маршрут</th>
                        <th class="py-3 text-center">Тривалість/Дистанція</th>
                        <th class="py-3 text-right pr-2">Результат</th>
                    </tr>
                </thead>
                <tbody id="logbookBody" class="text-xs"></tbody>
            </table>
        </div>
    </div>

    <script>
        let allFlights = [];
        const currentOp = localStorage.getItem('uav_op');
        const currentUnit = localStorage.getItem('uav_unit');

        async function loadData() {
            if (!currentOp || !currentUnit) {
                alert("Помилка авторизації. Поверніться на головну.");
                window.location.href = "/";
                return;
            }
            
            document.getElementById('userDisplay').innerText = `${currentUnit} | ${currentOp}`;

            try {
                const res = await fetch("/api/get_all_flights");
                allFlights = await res.json();
                
                const now = new Date();
                document.getElementById('monthSelect').value = String(now.getMonth() + 1).padStart(2, '0');
                
                populateDropdowns(); // Заповнюємо фільтри БпЛА і Результатів
                updateAnalytics();
            } catch (e) { console.error(e); }
        }

        // Автозаповнення випадаючих списків унікальними даними
        function populateDropdowns() {
            const userFlights = allFlights.filter(f => f.operator === currentOp && f.unit === currentUnit);
            
            // Дрони
            const uniqueDrones = [...new Set(userFlights.map(f => {
                return f.drone ? f.drone.split(' (')[0] : "";
            }))].filter(d => d !== "").sort();
            
            const droneSelect = document.getElementById('filterDrone');
            uniqueDrones.forEach(d => {
                droneSelect.add(new Option(d, d));
            });

            // Результати
            const uniqueResults = [...new Set(userFlights.map(f => f.result))].filter(r => r).sort();
            const resSelect = document.getElementById('filterResult');
            uniqueResults.forEach(r => {
                resSelect.add(new Option(r, r));
            });
        }

        function resetFilters() {
            document.getElementById('filterDate').value = "";
            document.getElementById('filterTimeStart').value = "";
            document.getElementById('filterTimeEnd').value = "";
            document.getElementById('filterDrone').value = "";
            document.getElementById('filterResult').value = "";
            
            // Скидаємо місяць на поточний
            const now = new Date();
            document.getElementById('monthSelect').value = String(now.getMonth() + 1).padStart(2, '0');
            document.getElementById('yearSelect').value = "2026";
            
            updateAnalytics();
        }

        function updateAnalytics() {
            const selectedMonth = document.getElementById('monthSelect').value;
            const selectedYear = document.getElementById('yearSelect').value;
            const targetPeriod = `${selectedYear}-${selectedMonth}`;

            // Отримуємо значення нових фільтрів
            const fDate = document.getElementById('filterDate').value;
            const fTimeStart = document.getElementById('filterTimeStart').value;
            const fTimeEnd = document.getElementById('filterTimeEnd').value;
            const fDrone = document.getElementById('filterDrone').value;
            const fResult = document.getElementById('filterResult').value;

            // ФІЛЬТРАЦІЯ
            const filtered = allFlights.filter(f => {
                // 1. Базова перевірка юзера
                if (f.operator !== currentOp || f.unit !== currentUnit) return false;

                // 2. Якщо вибрана конкретна дата - ігноруємо місяць/рік, інакше фільтруємо по місяцю
                if (fDate) {
                    if (f.date !== fDate) return false;
                } else {
                    if (!f.date || !f.date.startsWith(targetPeriod)) return false;
                }

                // 3. Час
                if (fTimeStart && f.takeoff < fTimeStart) return false;
                if (fTimeEnd && f.takeoff > fTimeEnd) return false;

                // 4. БпЛА (частковий збіг, бо в базі назва може бути з серійником)
                if (fDrone && (!f.drone || !f.drone.includes(fDrone))) return false;

                // 5. Результат
                if (fResult && f.result !== fResult) return false;

                return true;
            });

            // Далі йде стандартна логіка підрахунку статистики для filtered масиву
            const realFlights = filtered.filter(f => f.result !== "Польоти не здійснювались");

            // ЗМІННІ
            let totalMin = 0; 
            let detentions = 0;
            let maxDuration = 0; let maxDurationDate = "---";
            let maxDistance = 0; let maxDistanceDate = "---";
            const droneStats = {}; 
            const batteries = {};
            const flightsPerDay = {};

            filtered.forEach(f => {
                const isNoFly = f.result === "Польоти не здійснювались";
                const dur = isNoFly ? 0 : (parseInt(f.duration) || 0);
                const dist = isNoFly ? 0 : (parseInt(f.distance) || 0);
                
                totalMin += dur;
                if (f.result === "Затримання") detentions++;
                
                if (!isNoFly) {
                    if (dur > maxDuration) { maxDuration = dur; maxDurationDate = f.date; }
                    if (dist > maxDistance) { maxDistance = dist; maxDistanceDate = f.date; }
                    flightsPerDay[f.date] = (flightsPerDay[f.date] || 0) + 1;

                    const model = f.drone ? f.drone.split(' (')[0] : "Інші";
                    droneStats[model] = (droneStats[model] || 0) + 1;

                    if (f.battery_id) {
                        const cyc = parseInt(f.battery_cycles) || 0;
                        if (!batteries[f.battery_id] || cyc > batteries[f.battery_id].cycles) {
                            batteries[f.battery_id] = { cycles: cyc, drone: model };
                        }
                    }
                }
            });

            // Оновлення DOM
            document.getElementById('totalFlights').innerText = realFlights.length;
            document.getElementById('totalDuration').innerText = `${Math.floor(totalMin/60)}г ${totalMin%60}хв`;
            document.getElementById('totalResults').innerText = detentions;
            const eff = realFlights.length > 0 ? ((detentions / realFlights.length) * 100).toFixed(1) : 0;
            document.getElementById('efficiencyRate').innerText = `${eff}%`;

            document.getElementById('maxTime').innerText = maxDuration > 0 ? `${maxDuration} хв` : "---";
            document.getElementById('maxTimeDate').innerText = maxDurationDate;
            document.getElementById('maxDist').innerText = maxDistance > 0 ? `${maxDistance} м` : "---";
            document.getElementById('maxDistDate').innerText = maxDistanceDate;

            const bestDayEntry = Object.entries(flightsPerDay).sort((a,b) => b[1] - a[1])[0];
            if (bestDayEntry) {
                document.getElementById('bestDay').innerText = bestDayEntry[0];
                document.getElementById('bestDayCount').innerText = `${bestDayEntry[1]} вильотів`;
            } else {
                document.getElementById('bestDay').innerText = "---";
                document.getElementById('bestDayCount').innerText = "";
            }

            const droneCont = document.getElementById('droneRating');
            const sortedDrones = Object.entries(droneStats).sort((a,b) => b[1]-a[1]);
            const maxD = sortedDrones.length > 0 ? sortedDrones[0][1] : 1;
            
            droneCont.innerHTML = sortedDrones.length ? sortedDrones.map(([name, count]) => `
                <div>
                    <div class="flex justify-between text-[10px] mb-1 font-bold uppercase"><span>${name}</span><span class="text-orange-400">${count}</span></div>
                    <div class="w-full bg-slate-800 h-1.5 rounded-full"><div class="bg-orange-500 h-full rounded-full" style="width: ${(count/maxD)*100}%"></div></div>
                </div>`).join('') : '<div class="text-center text-slate-600 text-[10px]">Немає даних</div>';

            const batCont = document.getElementById('batteryResource');
            const sortedBats = Object.entries(batteries).sort((a,b) => b[1].cycles - a[1].cycles);
            batCont.innerHTML = sortedBats.length ? sortedBats.map(([id, data]) => `
                <div class="flex justify-between items-center p-2 bg-slate-800/40 rounded-lg border border-white/5">
                    <span class="text-[10px] font-mono text-teal-400">${id}</span>
                    <span class="text-xs font-black ${data.cycles > 150 ? 'text-red-500' : 'text-white'}">${data.cycles}</span>
                </div>`).join('') : '<div class="text-center text-slate-600 text-[10px]">Дані АКБ відсутні</div>';

            // Журнал
            const logBody = document.getElementById('logbookBody');
            if (filtered.length === 0) {
                logBody.innerHTML = '<tr><td colspan="5" class="py-10 text-center text-slate-600 text-[10px] font-bold uppercase">Журнал порожній за цей період</td></tr>';
            } else {
                const sortedLog = filtered.sort((a,b) => b.id - a.id);
                logBody.innerHTML = sortedLog.map(f => {
                    const dateParts = f.date ? f.date.split('-') : [];
                    const shortDate = dateParts.length === 3 ? `${dateParts[2]}.${dateParts[1]}` : f.date;
                    const droneShort = f.drone ? f.drone.split(' (')[0] : "БпЛА";
                    let sn = "---";
                    if (f.drone && f.drone.includes('S/N:')) {
                        sn = f.drone.split('S/N: ')[1].replace(')', '');
                    }
                    const isNoFly = f.result === "Польоти не здійснювались";
                    const rowClass = isNoFly ? "opacity-40 grayscale hover:grayscale-0 transition-all" : "hover:bg-slate-800/50";
                    const resultStyle = isNoFly 
                        ? "text-slate-400 border border-slate-600 rounded px-1" 
                        : (f.result === 'Затримання' ? 'bg-red-500/20 text-red-500 border border-red-500/30' : 'text-slate-500');

                    return `
                    <tr class="border-b border-slate-800 transition-colors group ${rowClass}">
                        <td class="py-3 pl-2 align-top">
                            <div class="font-bold text-white text-sm">${shortDate}</div>
                            <div class="text-[10px] text-slate-400 font-mono mt-1 bg-slate-800/60 inline-block px-1 rounded border border-slate-700">
                                ${f.takeoff} - ${f.landing}
                            </div>
                        </td>
                        <td class="py-3 align-top">
                            <div class="font-bold text-xs uppercase text-slate-200">${droneShort}</div>
                            <div class="text-[9px] text-slate-500 font-mono truncate max-w-[80px]" title="${sn}">${sn}</div>
                        </td>
                        <td class="py-3 align-top">
                            <div class="text-xs font-medium text-slate-300 truncate max-w-[120px]" title="${f.route}">${f.route || "---"}</div>
                        </td>
                        <td class="py-3 align-top text-center">
                            <div class="text-[10px] font-bold text-blue-400">
                                ${isNoFly ? '-' : f.duration + ' хв'}
                            </div>
                            <div class="text-[9px] text-slate-500 mt-1">
                                ${!isNoFly && f.distance ? f.distance + ' м' : ''} 
                                ${!isNoFly && f.battery_id ? '| ' + f.battery_id : ''}
                            </div>
                        </td>
                        <td class="py-3 align-top text-right pr-2">
                            <span class="inline-block px-2 py-1 rounded text-[10px] font-black uppercase ${resultStyle}">
                                ${f.result}
                            </span>
                        </td>
                    </tr>
                `}).join('');
            }
        }

        window.onload = loadData;
    </script>
</body>
</html>
