<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Analytics | Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { background: #0f172a; font-family: 'Inter', sans-serif; color: white; padding: 12px; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 1.5rem; }
        .stat-card { background: rgba(15, 23, 42, 0.6); padding: 15px; border-radius: 1rem; border: 1px solid rgba(255,255,255,0.05); }
        select { background: #1e293b !important; color: white !important; border: 1px solid #334155 !important; border-radius: 0.5rem; padding: 6px 12px; font-size: 12px; outline: none; }
        .rank-gold { color: #fbbf24; } /* Золото */
        .rank-silver { color: #94a3b8; } /* Срібло */
        .rank-bronze { color: #b45309; } /* Бронза */
    </style>
</head>
<body class="max-w-6xl mx-auto pb-10">

    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8 pt-4 px-2">
        <div class="flex items-center gap-4">
            <button onclick="nav('/admin')" class="p-2 bg-slate-800 rounded-xl text-slate-400 hover:text-white transition-all">
                <i class="fa-solid fa-arrow-left"></i>
            </button>
            <div>
                <h1 class="text-2xl font-black uppercase italic text-green-500 tracking-tighter leading-none">Глобальна Аналітика</h1>
                <p class="text-[9px] text-slate-500 uppercase font-bold tracking-widest mt-1">Контроль ефективності підрозділів</p>
            </div>
        </div>

        <div class="flex items-center gap-2 glass px-4 py-2">
            <i class="fa-solid fa-filter text-green-500 text-xs mr-1"></i>
            <select id="monthSelect" onchange="updateAnalytics()">
                <option value="all">Весь рік</option>
                <option value="01">Січень</option><option value="02">Лютий</option>
                <option value="03">Березень</option><option value="04">Квітень</option>
                <option value="05">Травень</option><option value="06">Червень</option>
                <option value="07">Липень</option><option value="08">Серпень</option>
                <option value="09">Вересень</option><option value="10">Жовтень</option>
                <option value="11">Листопад</option><option value="12">Грудень</option>
            </select>
            <select id="yearSelect" onchange="updateAnalytics()">
                <option value="2025">2025</option>
                <option value="2026" selected>2026</option>
            </select>
        </div>
    </div>

    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
        <div class="stat-card">
            <div class="text-[9px] text-slate-500 font-black uppercase italic">Всього вильотів</div>
            <div id="totalFlights" class="text-xl font-black text-white mt-1">0</div>
        </div>
        <div class="stat-card">
            <div class="text-[9px] text-slate-500 font-black uppercase italic">Загальний наліт</div>
            <div id="totalHours" class="text-xl font-black text-blue-400 mt-1">0г 0хв</div>
        </div>
        <div class="stat-card">
            <div class="text-[9px] text-slate-500 font-black uppercase italic">Затримання</div>
            <div id="totalDetentions" class="text-xl font-black text-red-500 mt-1">0</div>
        </div>
        <div class="stat-card">
            <div class="text-[9px] text-slate-500 font-black uppercase italic">Активні пілоти</div>
            <div id="activePilots" class="text-xl font-black text-orange-400 mt-1">0</div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <div class="lg:col-span-2 glass p-6">
            <h2 class="text-xs font-black uppercase mb-6 text-slate-400 italic flex items-center gap-2">
                <i class="fa-solid fa-trophy text-yellow-500"></i> Рейтинг операторів
            </h2>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead>
                        <tr class="text-[9px] uppercase text-slate-500 border-b border-white/5">
                            <th class="pb-3">Пілот</th>
                            <th class="pb-3 text-center">Завдання</th>
                            <th class="pb-3 text-center">Вильоти</th>
                            <th class="pb-3 text-center">Наліт</th>
                            <th class="pb-3 text-right">Результат</th>
                        </tr>
                    </thead>
                    <tbody id="pilotRankingBody" class="text-sm">
                        </tbody>
                </table>
            </div>
        </div>

        <div class="space-y-6">
            <div class="glass p-6">
                <h2 class="text-xs font-black uppercase mb-4 text-slate-400 italic">
                    <i class="fa-solid fa-plane-up text-blue-500 mr-2"></i> Використання БпЛА
                </h2>
                <div id="droneStats" class="space-y-4"></div>
            </div>

            <div class="glass p-6">
                <h2 class="text-xs font-black uppercase mb-4 text-slate-400 italic">
                    <i class="fa-solid fa-battery-half text-red-500 mr-2"></i> Критичний знос АКБ
                </h2>
                <div id="batteryStats" class="space-y-3"></div>
            </div>
        </div>

    </div>

    <script>
        let allFlights = [];

        function nav(path) {
            const token = new URLSearchParams(window.location.search).get('token');
            window.location.href = token ? `${path}?token=${token}` : path;
        }

        async function loadData() {
            try {
                const res = await fetch("/api/get_all_flights");
                allFlights = await res.json();
                updateAnalytics();
            } catch (e) { console.error(e); }
        }

        function updateAnalytics() {
            const m = document.getElementById('monthSelect').value;
            const y = document.getElementById('yearSelect').value;
            
            // Фільтрація за часом
            const filtered = allFlights.filter(f => {
                if (!f.date) return false;
                const matchesYear = f.date.startsWith(y);
                const matchesMonth = m === 'all' ? true : f.date.includes(`-${m}-`);
                return matchesYear && matchesMonth;
            });

            // Обчислення
            let totalMin = 0;
            let detentions = 0;
            const pilots = {};
            const drones = {};
            const batteries = {};

            filtered.forEach(f => {
                const dur = parseInt(f.duration) || 0;
                totalMin += dur;
                if (f.result === "Затримання") detentions++;

                // Статистика Пілотів
                if (!pilots[f.operator]) {
                    pilots[f.operator] = { missions: new Set(), flights: 0, time: 0, det: 0 };
                }
                const p = pilots[f.operator];
                p.flights += 1;
                p.time += dur;
                if (f.result === "Затримання") p.det += 1;
                // Польотне завдання = Дата + Зміна + Маршрут
                p.missions.add(`${f.date}_${f.shift_time}_${f.route}`);

                // Статистика БпЛА
                const dName = f.drone ? f.drone.split(' (')[0] : 'Unknown';
                drones[dName] = (drones[dName] || 0) + 1;

                // Статистика АКБ
                if (f.battery_id) {
                    const cyc = parseInt(f.battery_cycles) || 0;
                    if (!batteries[f.battery_id] || cyc > batteries[f.battery_id].cyc) {
                        batteries[f.battery_id] = { cyc: cyc, drone: dName };
                    }
                }
            });

            // Оновлення карток
            document.getElementById('totalFlights').innerText = filtered.length;
            document.getElementById('totalHours').innerText = `${Math.floor(totalMin/60)}г ${totalMin%60}хв`;
            document.getElementById('totalDetentions').innerText = detentions;
            document.getElementById('activePilots').innerText = Object.keys(pilots).length;

            // Рендер рейтингу пілотів
            const rankingBody = document.getElementById('pilotRankingBody');
            const sortedPilots = Object.entries(pilots).sort((a,b) => b[1].time - a[1].time);
            
            rankingBody.innerHTML = sortedPilots.map(([name, data], index) => {
                let rankClass = '';
                if (index === 0) rankClass = 'rank-gold';
                else if (index === 1) rankClass = 'rank-silver';
                else if (index === 2) rankClass = 'rank-bronze';

                return `
                <tr class="border-b border-white/5 hover:bg-white/5 transition-colors">
                    <td class="py-4 font-bold flex items-center gap-2">
                        <span class="${rankClass} text-[10px] w-4">${index + 1}.</span>
                        ${name}
                    </td>
                    <td class="py-4 text-center font-mono text-xs text-slate-400">${data.missions.size}</td>
                    <td class="py-4 text-center font-mono text-xs text-slate-400">${data.flights}</td>
                    <td class="py-4 text-center font-black text-blue-400">${Math.floor(data.time/60)}г ${data.time%60}хв</td>
                    <td class="py-4 text-right font-black ${data.det > 0 ? 'text-red-500' : 'text-slate-600'}">${data.det}</td>
                </tr>`;
            }).join('') || '<tr><td colspan="5" class="py-10 text-center text-slate-600 uppercase text-[10px] font-black tracking-widest">Немає даних за цей період</td></tr>';

            // Рендер дронів
            const droneContainer = document.getElementById('droneStats');
            const sortedDrones = Object.entries(drones).sort((a,b) => b[1] - a[1]);
            const maxD = sortedDrones.length > 0 ? sortedDrones[0][1] : 1;
            droneContainer.innerHTML = sortedDrones.map(([name, count]) => `
                <div>
                    <div class="flex justify-between text-[10px] mb-1 font-bold"><span>${name}</span><span class="text-blue-400">${count}</span></div>
                    <div class="w-full bg-slate-800 h-1.5 rounded-full overflow-hidden">
                        <div class="bg-blue-500 h-full transition-all duration-1000" style="width: ${(count/maxD)*100}%"></div>
                    </div>
                </div>`).join('') || '<div class="text-center text-slate-700 text-[10px]">---</div>';

            // Рендер АКБ (тільки критичні > 150 або топ 3 по зносу)
            const batContainer = document.getElementById('batteryStats');
            const sortedBats = Object.entries(batteries).sort((a,b) => b[1].cyc - a[1].cyc).slice(0, 4);
            batContainer.innerHTML = sortedBats.map(([id, data]) => `
                <div class="flex justify-between items-center p-3 ${data.cyc >= 150 ? 'bg-red-500/10 border-red-500/20' : 'bg-slate-800/40'} border border-transparent rounded-xl">
                    <div class="text-[10px] font-mono ${data.cyc >= 150 ? 'text-red-400' : 'text-slate-400'}">${id}</div>
                    <div class="text-xs font-black">${data.cyc} <span class="text-[8px] font-normal opacity-50 uppercase">цикл.</span></div>
                </div>`).join('') || '<div class="text-center text-slate-700 text-[10px]">---</div>';
        }

        window.onload = loadData;
    </script>
</body>
</html>