<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Журнал польотів | UAV Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { background: #0f172a; font-family: 'Inter', sans-serif; color: white; padding: 8px; }
        .session-block { background: rgba(30, 41, 59, 0.4); border-left: 3px solid #22c55e; margin-bottom: 1rem; border-radius: 1rem; padding: 0.75rem; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .tech-label { font-size: 7px; text-transform: uppercase; color: #64748b; font-weight: 800; letter-spacing: 0.02em; line-height: 1; }
        .tech-value { font-size: 10px; font-weight: 700; color: #f8fafc; }
    </style>
</head>
<body class="max-w-md mx-auto">

    <div class="flex justify-between items-center mb-4 px-2">
        <button onclick="window.location.href='/'" class="bg-slate-800 p-2 rounded-xl text-slate-400"><i class="fa-solid fa-chevron-left"></i></button>
        <h1 class="text-sm font-black uppercase italic text-green-500">Мій Журнал Польотів</h1>
        <button onclick="exportToExcel()" class="bg-green-600/20 text-green-400 p-2 rounded-xl border border-green-500/30">
            <i class="fa-solid fa-file-excel"></i>
        </button>
    </div>

    <div id="sessionsContainer" class="space-y-4">
        </div>

    <script>
        const API = window.location.origin + "/api";
        let flights = [];

        async function load() {
            const unit = localStorage.getItem('uav_unit');
            const op = localStorage.getItem('uav_op');
            if(!unit || !op) return window.location.href = '/';

            const res = await fetch(`${API}/get_my_flights?unit=${encodeURIComponent(unit)}&operator=${encodeURIComponent(op)}`);
            flights = await res.json();
            renderBlocks();
        }

        function renderBlocks() {
            const container = document.getElementById('sessionsContainer');
            if (flights.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-500 py-10 uppercase font-black italic text-[10px]">Записів не знайдено</div>';
                return;
            }

            const groups = {};
            flights.forEach(f => {
                // ПРИМУСОВА КОНВЕРТАЦІЯ ДАТИ ДЛЯ ВІДОБРАЖЕННЯ
                const cleanDate = f.date.includes('-') ? f.date.split('-').reverse().join('.') : f.date;
                const key = cleanDate + " | " + f.shift_time;
                if (!groups[key]) groups[key] = [];
                groups[key].push(f);
            });

            container.innerHTML = Object.keys(groups).map(key => `
                <div class="session-block">
                    <div class="flex justify-between items-end mb-2 pb-1 border-b border-slate-700/30">
                        <div>
                            <div class="tech-label">Сесія</div>
                            <div class="text-[10px] font-bold text-green-400">${key}</div>
                        </div>
                        <div class="text-right">
                            <div class="tech-label">Загальний час</div>
                            <div class="text-[10px] font-mono text-slate-400">
                                ${groups[key].reduce((sum, f) => {
                                    const m = parseInt(f.duration) || 0;
                                    return sum + m;
                                }, 0)} хв
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 gap-2">
                        ${groups[key].map(f => `
                            <div class="bg-slate-900/40 p-2 rounded-lg border border-slate-800/50">
                                <div class="flex justify-between items-start">
                                    <div class="text-[9px] font-black text-purple-400 uppercase">${f.drone}</div>
                                    <div class="text-[9px] font-mono text-slate-400">${f.takeoff} - ${f.landing}</div>
                                </div>
                                <div class="grid grid-cols-3 gap-1 mt-1">
                                    <div><div class="tech-label">Наліт</div><div class="tech-value text-blue-400">${f.duration} хв</div></div>
                                    <div><div class="tech-label">АКБ</div><div class="tech-value">${f.battery_id}</div></div>
                                    <div><div class="tech-label">Цикли</div><div class="tech-value">${f.battery_cycles}</div></div>
                                </div>
                                <div class="flex justify-between items-center mt-1 pt-1 border-t border-slate-800/20">
                                    <div class="text-[7px] text-slate-600 italic truncate max-w-[80%]">${f.route || '---'}</div>
                                    <button onclick="del(${f.id})" class="text-red-900/50 hover:text-red-500">
                                        <i class="fa-solid fa-trash-can text-[8px]"></i>
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        async function del(id) {
            if(confirm("Видалити цей запис?")) {
                await fetch(`${API}/delete_flight/${id}`, {method:'DELETE'});
                load();
            }
        }

        function exportToExcel() {
            if (flights.length === 0) return alert("Немає даних для експорту");

            // 1. Складна шапка згідно з Журналом
            const header = [
                ["ЖУРНАЛ обліку польотів із застосуванням БпЛА відділом повітряної розвідки та протидії БпС"],
                [], // Відступ
                [
                    "№", "Дата", "Вид БпЛА", "Ділянка", "Час зльоту", "Час посадки", 
                    "Тривалість польоту год., хв", "", "", "Підстава для польоту", "", "", 
                    "Висота польоту м. (min)", "Висота польоту м. (max)", "в/зв, ПІБ оператора", "", "Підпис", "Прим.", "Номер АКБ", "Цикли АКБ"
                ]
            ];

            // 2. Дані (використовуємо змінені назви колонок)
            const rows = flights.map((f, index) => [
                index + 1,
                f.date.includes('-') ? f.date.split('-').reverse().join('.') : f.date, // Дата дд.мм.рррр
                f.drone,
                f.route || "",
                f.takeoff,
                f.landing,
                f.duration + " хв",
                "", "",
                "Патрулювання",
                "", "", "", "",
                f.operator,
                "", "", "",
                f.battery_id,
                f.battery_cycles
            ]);

            const ws = XLSX.utils.aoa_to_sheet(header.concat(rows));

            // Ширина колонок
            ws['!cols'] = [
                {wch: 4}, {wch: 12}, {wch: 35}, {wch: 25}, {wch: 10}, {wch: 10}, 
                {wch: 15}, {wch: 5}, {wch: 5}, {wch: 20}, {wch: 5}, {wch: 5}, 
                {wch: 10}, {wch: 10}, {wch: 25}, {wch: 5}, {wch: 10}, {wch: 10}, {wch: 12}, {wch: 10}
            ];

            // Об'єднання заголовка
            ws['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: 19 } }];

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Journal");
            XLSX.writeFile(wb, `Journal_UAV_${new Date().toLocaleDateString('uk-UA')}.xlsx`);
        }

        window.onload = load;
    </script>
</body>
</html>
