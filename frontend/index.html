<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UAV Workstation | Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%); min-height: 100vh; font-family: 'Inter', sans-serif; color: white; padding: 8px; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .label-style { font-size: 9px; text-transform: uppercase; font-weight: 800; color: #94a3b8; margin-bottom: 0.1rem; display: block; }
        input, select, textarea { background: #0f172a !important; color: white !important; border: 1px solid #334155 !important; border-radius: 0.5rem; font-size: 14px !important; width: 100%; outline: none; transition: all 0.2s; }
        input:focus { border-color: #22c55e !important; }
        .btn-green { background: #16a34a; font-weight: 900; text-transform: uppercase; }
        .cus-box { background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(255,255,255,0.05); border-radius: 0.75rem; padding: 8px; }
    </style>
</head>
<body class="flex items-center justify-center">

    <div id="loginScreen" class="w-full max-w-md glass p-8 rounded-[2rem] hidden">
        <h1 class="text-2xl font-black text-center text-green-500 mb-6 uppercase italic">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è</h1>
        <div class="space-y-3">
            <div><label class="label-style italic">–ü—ñ–¥—Ä–æ–∑–¥—ñ–ª</label><select id="loginUnit" class="p-3"></select></div>
            <div><label class="label-style italic">–ü—Ä—ñ–∑–≤–∏—â–µ</label><input type="text" id="loginOp" class="p-3"></div>
            <button onclick="saveAuth()" class="w-full btn-green py-4 rounded-xl text-slate-900 mt-2">–£–≤—ñ–π—Ç–∏</button>
        </div>
    </div>

    <div id="mainScreen" class="w-full max-w-6xl mx-auto flex flex-col lg:flex-row gap-4 hidden">
        <div class="lg:w-1/2 glass p-4 rounded-[1.5rem] h-fit">
            <div class="flex justify-between items-center mb-4 border-b border-slate-700 pb-2">
                <div id="userBadge" class="text-[10px] font-black text-green-500 uppercase italic"></div>
                <div class="flex gap-2">
                    <button onclick="nav('/request')" class="p-2 bg-purple-500/20 text-purple-400 rounded-lg border border-purple-500/30 hover:bg-purple-500/40 transition-all"><i class="fa-solid fa-file-signature"></i></button>
                    <button onclick="nav('/dashboard')" class="p-2 bg-blue-500/20 text-blue-400 rounded-lg"><i class="fa-solid fa-journal-whills"></i></button>
                    <button onclick="nav('/analytics')" class="p-2 bg-orange-500/20 text-orange-400 rounded-lg border border-orange-500/30" title="–ê–Ω–∞–ª—ñ—Ç–∏–∫–∞"><i class="fa-solid fa-chart-line"></i></button>
                    <button onclick="nav('/handbook')" class="p-2 bg-teal-500/20 text-teal-400 rounded-lg border border-teal-500/30" title="–î–æ–≤—ñ–¥–Ω–∏–∫"><i class="fa-solid fa-book-open"></i></button>
                    <button onclick="logout()" class="p-2 bg-red-500/20 text-red-400 rounded-lg"><i class="fa-solid fa-power-off"></i></button>
                </div>
            </div>

            <form id="flightForm" class="space-y-3">
                <div class="grid grid-cols-2 gap-2">
                    <div><label class="label-style">–î–∞—Ç–∞</label><input type="date" id="date" class="p-2"></div>
                    <div><label class="label-style">–ß–∞—Å –ø–æ–ª—å–æ—Ç–Ω–æ–≥–æ –∑–∞–≤–¥–∞–Ω–Ω—è</label>
                        <div class="flex gap-1"><input type="time" id="s1" value="08:00" class="p-2 text-center"><input type="time" id="s2" value="20:00" class="p-2 text-center"></div>
                    </div>
                </div>
                <div><label class="label-style">–ë–ø–õ–ê</label><select id="drone" class="p-2 text-green-400 font-bold"><option>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</option></select></div>
                <div><label class="label-style">–ú–∞—Ä—à—Ä—É—Ç</label><input type="text" id="route" class="p-2"></div>
                <div class="grid grid-cols-2 gap-2 bg-slate-900/60 p-2 rounded-xl border border-slate-800 text-center">
                    <div><label class="label-style text-green-500">–ó–ª—ñ—Ç</label><input type="tel" id="t1" placeholder="930" class="p-1 text-lg font-mono text-green-400 text-center bg-transparent border-none"></div>
                    <div><label class="label-style text-red-500">–ü–æ—Å–∞–¥–∫–∞</label><input type="tel" id="t2" placeholder="1015" class="p-1 text-lg font-mono text-red-400 text-center bg-transparent border-none"></div>
                </div>
                <div class="grid grid-cols-3 gap-2">
                    <div><label class="label-style">–î–∏—Å—Ç.(–º)</label><input type="number" id="dist" inputmode="numeric" class="p-2"></div>
                    <div><label class="label-style">‚Ññ –ê–ö–ë</label><input type="text" id="akb" class="p-2"></div>
                    <div><label class="label-style">–¶–∏–∫–ª–∏</label><input type="number" id="cyc" inputmode="numeric" class="p-2"></div>
                </div>
                <div class="grid grid-cols-3 gap-2 border-b border-slate-800 pb-3">
                    <div><label class="label-style">–ü–æ–≥–æ–¥–Ω—ñ —É–º–æ–≤–∏</label><select id="weather" class="p-2 text-[10px]"></select></div>
                    <div><label class="label-style">–£–º–æ–≤–∏ –ø–æ–ª—å–æ—Ç—É</label><select id="mode" class="p-2 text-[10px]"></select></div>
                    <div><label class="label-style text-orange-400">–†–µ–∑—É–ª—å—Ç–∞—Ç</label><select id="result" class="p-2 text-[10px] text-orange-400 font-bold"></select></div>
                </div>
                <div class="bg-slate-900/40 p-3 rounded-xl border border-dashed border-slate-700">
                    <label class="label-style">–°–∫—Ä—ñ–Ω—à–æ—Ç–∏ / –§–æ—Ç–æ –¥–æ–Ω–µ—Å–µ–Ω–Ω—è</label>
                    <input type="file" id="photos" multiple accept="image/*" class="text-[10px] text-slate-500">
                </div>
                <button type="button" onclick="addToDraft()" class="w-full bg-blue-600 py-3 rounded-xl font-black uppercase text-sm shadow-lg active:scale-95 transition-all">–î–æ–¥–∞—Ç–∏ –≤ —á–µ—Ä–Ω–µ—Ç–∫—É</button>
            </form>
        </div>

        <div class="lg:w-1/2 glass p-4 rounded-[1.5rem] flex flex-col">
            <h2 class="text-[11px] font-black uppercase text-slate-500 mb-2 italic">–ß–µ—Ä–Ω–µ—Ç–∫–∞ (<span id="draftCount">0</span>)</h2>
            <div id="draftList" class="flex-grow space-y-2 overflow-y-auto max-h-[250px] mb-4"></div>

            <div class="grid grid-cols-2 gap-2 mb-4">
                <div class="cus-box">
                    <div class="flex justify-between mb-1"><span class="text-[8px] font-black uppercase text-green-500 tracking-tighter">–î–æ 00:00</span><button onclick="copyText('cusBefore')" class="text-[8px] text-blue-400 font-bold">–ö–æ–ø—ñ—é–≤–∞—Ç–∏</button></div>
                    <textarea id="cusBefore" readonly class="w-full bg-transparent p-1 text-[10px] h-14 text-slate-400 font-mono outline-none resize-none"></textarea>
                </div>
                <div class="cus-box">
                    <div class="flex justify-between mb-1"><span class="text-[8px] font-black uppercase text-blue-500 tracking-tighter">–ü—ñ—Å–ª—è 00:00</span><button onclick="copyText('cusAfter')" class="text-[8px] text-blue-400 font-bold">–ö–æ–ø—ñ—é–≤–∞—Ç–∏</button></div>
                    <textarea id="cusAfter" readonly class="w-full bg-transparent p-1 text-[10px] h-14 text-slate-400 font-mono outline-none resize-none"></textarea>
                </div>
            </div>

            <button id="publishBtn" onclick="publishAll()" disabled class="w-full btn-green py-4 rounded-xl text-slate-900 mt-auto font-black uppercase shadow-xl">–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏ –¥–æ–Ω–µ—Å–µ–Ω–Ω—è</button>
        </div>
    </div>

    <script>
        const API = window.location.origin + "/api";
        let draft = [];

        function nav(path) {
            const token = new URLSearchParams(window.location.search).get('token');
            window.location.href = token ? `${path}?token=${token}` : path;
        }

        function formatTimeInput(val) {
            let clean = val.replace(/\D/g, '');
            if (clean.length === 3) clean = '0' + clean;
            if (clean.length === 4) {
                let h = clean.slice(0, 2), m = clean.slice(2, 4);
                if (parseInt(h) < 24 && parseInt(m) < 60) return h + ":" + m;
            }
            return val;
        }

        const timeIds = ['t1', 't2', 's1', 's2'];
        timeIds.forEach(id => {
            const el = document.getElementById(id);
            if(el) el.addEventListener('blur', function() { this.value = formatTimeInput(this.value); });
        });

        window.onload = async function() {
            const res = await fetch(API + "/get_options");
            const opt = await res.json();
            document.getElementById('loginUnit').innerHTML = opt.units.map(u => "<option>" + u + "</option>").join('');
            document.getElementById('weather').innerHTML = opt.weather.map(w => "<option>" + w + "</option>").join('');
            document.getElementById('mode').innerHTML = opt.flight_modes.map(m => "<option>" + m + "</option>").join('');
            document.getElementById('result').innerHTML = opt.results.map(r => "<option>" + r + "</option>").join('');

            const u = localStorage.getItem('uav_unit'), o = localStorage.getItem('uav_op');
            if (u && o) {
                document.getElementById('loginUnit').value = u; 
                document.getElementById('loginOp').value = o;
                document.getElementById('userBadge').innerText = u + " | " + o;
                showMain(u);
            } else document.getElementById('loginScreen').classList.remove('hidden');

            const cached = localStorage.getItem('uav_draft_cache');
            if (cached) { draft = JSON.parse(cached); renderDraft(); }
            if (localStorage.getItem('last_route')) document.getElementById('route').value = localStorage.getItem('last_route');
        };

        async function showMain(unit) {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainScreen').classList.remove('hidden');
            const resD = await fetch(API + "/get_unit_drones?unit=" + encodeURIComponent(unit));
            const drones = await resD.json();
            document.getElementById('drone').innerHTML = drones.map(d => '<option value="' + d.model + ' (S/N: ' + d.serial_number + ')">' + d.model + ' [' + d.serial_number + ']</option>').join('');
            document.getElementById('date').valueAsDate = new Date();
        }

        function saveAuth() {
            localStorage.setItem('uav_unit', document.getElementById('loginUnit').value);
            localStorage.setItem('uav_op', document.getElementById('loginOp').value);
            location.reload();
        }

        function addToDraft() {
    // 1. –û—Ç—Ä–∏–º—É—î–º–æ –æ–±–æ–≤'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è
    const takeoffInput = document.getElementById('t1'); // –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ id 't1' –∞–±–æ 'takeoff'
    const landingInput = document.getElementById('t2'); // –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ id 't2' –∞–±–æ 'landing'
    
    if (!takeoffInput || !landingInput || !takeoffInput.value || !landingInput.value) {
        return alert("–°–ø–æ—á–∞—Ç–∫—É –≤–∫–∞–∂—ñ—Ç—å –ß–ê–° –∑–ª—å–æ—Ç—É —Ç–∞ –ø–æ—Å–∞–¥–∫–∏!");
    }

    // 2. –§—É–Ω–∫—Ü—ñ—è –±–µ–∑–ø–µ—á–Ω–æ–≥–æ –∑–±–æ—Ä—É –¥–∞–Ω–∏—Ö (—è–∫—â–æ –µ–ª–µ–º–µ–Ω—Ç–∞ –Ω–µ–º–∞—î - –±–µ—Ä–µ–º–æ –¥–µ—Ñ–æ–ª—Ç)
    const getVal = (id, def) => {
        const el = document.getElementById(id);
        return el ? el.value : def;
    };

    // 3. –§–æ—Ä–º—É—î–º–æ –æ–±'—î–∫—Ç –ø–æ–ª—å–æ—Ç—É
    const flight = {
        id: Date.now(),
        date: getVal('date', new Date().toLocaleDateString('uk-UA')),
        shift_time: (getVal('s1', '08:00') + "-" + getVal('s2', '20:00')),
        operator: localStorage.getItem('uav_op') || "–ù–µ–≤—ñ–¥–æ–º–∏–π",
        unit: localStorage.getItem('uav_unit') || "–ù–µ –≤–∫–∞–∑–∞–Ω–æ",
        drone: getVal('drone', '–ë–ø–õ–ê'),
        route: getVal('route', '–ü–∞—Ç—Ä—É–ª—é–≤–∞–Ω–Ω—è'),
        takeoff: takeoffInput.value,
        landing: landingInput.value,
        distance: getVal('dist', 0),
        battery_id: getVal('akb', '‚Äî'),
        battery_cycles: getVal('cyc', 0),
        
        // –¶—ñ –ø–æ–ª—è —Ç–µ–ø–µ—Ä –Ω–µ –ª–∞–º–∞—é—Ç—å –∫–æ–¥, –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ —ó—Ö –Ω–µ–º–∞—î –≤ HTML
        weather: getVal('weather', '–ù–æ—Ä–º–∞–ª—å–Ω—ñ'),
        conditions: getVal('flight_conditions', '–ù–æ—Ä–º–∞'),
        result: getVal('result', '–ë–µ–∑ –æ–∑–Ω–∞–∫ –ø–æ—Ä—É—à–µ–Ω–Ω—è')
    };

    // 4. –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ —Ç—Ä–∏–≤–∞–ª–æ—Å—Ç—ñ (—è–∫—â–æ —Ñ—É–Ω–∫—Ü—ñ—è calculateDuration –¥–æ—Å—Ç—É–ø–Ω–∞)
    if (typeof calculateDuration === "function") {
        flight.duration = calculateDuration(flight.takeoff, flight.landing);
    } else {
        // –ü—Ä–æ—Å—Ç–∏–π —Ä–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ, —è–∫—â–æ —Ñ—É–Ω–∫—Ü—ñ—ó –Ω–µ–º–∞—î
        const [h1, m1] = flight.takeoff.split(':').map(Number);
        const [h2, m2] = flight.landing.split(':').map(Number);
        let diff = (h2 * 60 + m2) - (h1 * 60 + m1);
        flight.duration = diff > 0 ? diff : diff + 1440;
    }

    // 5. –î–æ–¥–∞—î–º–æ –≤ –º–∞—Å–∏–≤ —Ç–∞ –æ–Ω–æ–≤–ª—é—î–º–æ –µ–∫—Ä–∞–Ω
    draft.push(flight);
    localStorage.setItem('uav_draft_cache', JSON.stringify(draft)); // –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∫–µ—à—É
    
    if (typeof renderDraft === "function") {
        renderDraft();
    }
    
    // –û—á–∏—â–µ–Ω–Ω—è –ø–æ–ª—ñ–≤ –ø—ñ—Å–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è
    takeoffInput.value = "";
    landingInput.value = "";
    if(document.getElementById('dist')) document.getElementById('dist').value = "";
}

        function renderDraft() {
            document.getElementById('draftCount').innerText = draft.length;
            document.getElementById('publishBtn').disabled = draft.length === 0;
            document.getElementById('draftList').innerHTML = draft.map(f => `
                <div class="bg-slate-900/80 p-3 rounded-xl border border-slate-700 flex justify-between items-center">
                    <div class="text-[10px]"><div class="font-bold text-green-500">${f.takeoff} ‚Üí ${f.landing}</div><div class="text-slate-400 uppercase">${f.drone.split(' (')[0]}</div></div>
                    <button onclick="removeFromDraft(${f.id})" class="text-red-500 p-2"><i class="fa-solid fa-trash-can"></i></button>
                </div>`).join('');
            generateCUS();
        }

        function generateCUS() {
            let b = "", a = "";
            draft.forEach(f => {
                const [h1, m1] = f.takeoff.split(':').map(Number), [h2, m2] = f.landing.split(':').map(Number);
                let d = (h2 * 60 + m2) - (h1 * 60 + m1); if (d <= 0) d += 1440;
                const line = f.takeoff + "-" + f.landing + " - " + f.distance + "–º (" + d + " —Ö–≤)\n";
                if (f.takeoff < "08:00" || f.takeoff > "20:00") a += line; else b += line;
            });
            document.getElementById('cusBefore').value = b || "---"; document.getElementById('cusAfter').value = a || "---";
        }

        function removeFromDraft(id) { draft = draft.filter(f => f.id !== id); localStorage.setItem('uav_draft_cache', JSON.stringify(draft)); renderDraft(); }

        function copyText(id) {
            const el = document.getElementById(id); if (el.value === "---") return;
            navigator.clipboard.writeText(el.value); alert("–°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!");
        }

        async function publishAll() {
    if (draft.length === 0) return;
    const btn = document.getElementById('publishBtn'); 
    btn.disabled = true; 
    btn.innerText = "–ù–ê–î–°–ò–õ–ê–ù–ù–Ø...";

    const first = draft[0];
    const currentShift = (document.getElementById('s1')?.value || "08:00") + "-" + (document.getElementById('s2')?.value || "20:00");
    const currentRoute = document.getElementById('route')?.value || "–ù–µ –≤–∫–∞–∑–∞–Ω–æ";
    
    let report = "<b>–î–æ–Ω–µ—Å–µ–Ω–Ω—è:</b> " + first.unit + "\n" +
                 "<b>–ü—ñ–ª–æ—Ç:</b> " + first.operator + "\n" +
                 "<b>–î–∞—Ç–∞:</b> " + first.date + "\n" +
                 "<b>–ß–∞—Å –∑–∞–≤–¥–∞–Ω–Ω—è:</b> " + currentShift + "\n" +
                 "<b>–ë–ø–õ–ê:</b> " + first.drone + "\n" +
                 "<b>–ú–∞—Ä—à—Ä—É—Ç:</b> " + currentRoute + "\n" +
                 "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n" +
                 "<b>–í–∏–ª—å–æ—Ç–∏:</b>\n";
    
    draft.forEach((f, i) => {
        report += (i + 1) + ". " + f.takeoff + "-" + f.landing + " (" + f.duration + " —Ö–≤)\n";

        // –ó–±–∏—Ä–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ "–∞–Ω–æ–º–∞–ª—ñ—ó"
        let statusParts = [];
        if (f.weather && f.weather !== "–ù–æ—Ä–º–∞–ª—å–Ω—ñ") statusParts.push("‚òÅÔ∏è " + f.weather);
        if (f.conditions && f.conditions !== "–ù–æ—Ä–º–∞") statusParts.push("‚ö†Ô∏è " + f.conditions);
        if (f.result && f.result !== "–ë–µ–∑ –æ–∑–Ω–∞–∫ –ø–æ—Ä—É—à–µ–Ω–Ω—è") statusParts.push("üéØ <b>" + f.result + "</b>");

        // –î–æ–¥–∞—î–º–æ —Ä—è–¥–æ–∫ —Å—Ç–∞—Ç—É—Å—ñ–≤ –ø—ñ–¥ –ø–æ–ª—å–æ—Ç–æ–º, —è–∫—â–æ –≤–æ–Ω–∏ —î
        if (statusParts.length > 0) {
            report += "   ‚îî " + statusParts.join(" | ") + "\n";
        }
    });

    try {
        // –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ –±–∞–∑—É (Supabase)
        for (const f of draft) {
            let [d, m, y] = f.date.split('.');
            const dbDate = `${y}-${m}-${d}`;
            const toDb = { ...f, date: dbDate, shift_time: currentShift, route: currentRoute };
            delete toDb.id;
            await fetch(API + "/add_flight", { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(toDb) });
        }
        
        // –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –≤ Telegram
        const fd = new FormData(); 
        fd.append('report_text', report);
        const ph = document.getElementById('photos');
        if (ph && ph.files.length > 0) {
            Array.from(ph.files).forEach(file => fd.append('images', file));
        }

        const resT = await fetch(API + "/publish_with_telegram", { method: 'POST', body: fd });
        if ((await resT.json()).status === "ok") { 
            alert("–£—Å–ø—ñ—à–Ω–æ –æ–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω–æ!"); 
            draft = []; 
            localStorage.removeItem('uav_draft_cache'); 
            location.reload(); 
        }
    } catch (e) { 
        alert("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤—ñ–¥–ø—Ä–∞–≤—Ü—ñ!"); 
    } finally { 
        btn.disabled = false; 
        btn.innerText = "–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏ –¥–æ–Ω–µ—Å–µ–Ω–Ω—è"; 
    }
}

        function logout() { if(confirm("–í–∏–π—Ç–∏?")) { localStorage.clear(); location.reload(); } }
    </script>
</body>
</html>
